<!DOCTYPE html>
<html>
<head>
  <title>Iron Companies - Employee Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .message {
      background: rgba(255,255,255,0.08);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
    }

    .reply {
      border-left: 3px solid #00d4ff;
      margin-left: 15px;
      background: rgba(0,212,255,0.08);
    }

    .username {
      font-weight: bold;
      color: #00d4ff;
    }

    .time {
      font-size: 11px;
      opacity: 0.6;
      margin-left: 8px;
    }

    .reply-btn {
      font-size: 11px;
      cursor: pointer;
      color: #00d4ff;
      margin-top: 5px;
    }

    img {
      max-width: 200px;
      border-radius: 8px;
      margin-top: 6px;
    }

    #replyingTo {
      background: rgba(0,212,255,0.2);
      padding: 6px;
      display: none;
      font-size: 12px;
    }

    .input-area {
      display: flex;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      gap: 5px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    button {
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #00d4ff;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }

    input[type="file"] {
      color: white;
    }
  </style>
</head>

<body>

<header>Iron Companies Employee Chat</header>

<div id="messages"></div>

<div id="replyingTo"></div>

<div class="input-area">
  <input type="file" id="imageInput">
  <input type="text" id="messageInput" placeholder="Type message...">
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    orderBy, 
    onSnapshot, 
    serverTimestamp,
    getDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD6c1k8BURliiSAwEOnT_HW1MaZjNhHJSM",
    authDomain: "iron-companies.firebaseapp.com",
    projectId: "iron-companies",
    storageBucket: "iron-companies.firebasestorage.app",
    messagingSenderId: "692492696732",
    appId: "1:692492696732:web:cd29fc124ddc0fa014c159"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUserData = null;
  let replyToMessage = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    const userDoc = await getDoc(doc(db, "users", user.uid));
    currentUserData = userDoc.data();
    loadMessages();
  });

  window.sendMessage = async () => {
    const input = document.getElementById("messageInput");
    const fileInput = document.getElementById("imageInput");
    const file = fileInput.files[0];
    const text = input.value.trim();

    if (!text && !file) return;

    let imageBase64 = "";

    if (file) {
      if (file.size > 700000) {
        alert("Image too large.");
        return;
      }

      imageBase64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    await addDoc(collection(db, "messages"), {
      text: text,
      imageBase64: imageBase64,
      username: currentUserData.username,
      userId: auth.currentUser.uid,
      createdAt: serverTimestamp(),
      replyTo: replyToMessage || null
    });

    input.value = "";
    fileInput.value = "";
    replyToMessage = null;
    document.getElementById("replyingTo").style.display = "none";
  };

  function loadMessages() {
    const q = query(collection(db, "messages"), orderBy("createdAt"));
    onSnapshot(q, (snapshot) => {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";

      snapshot.forEach((docSnap) => {
        const msg = docSnap.data();
        const msgId = docSnap.id;

        const div = document.createElement("div");
        div.className = "message";
        if (msg.replyTo) div.classList.add("reply");

        const date = msg.createdAt?.toDate();
        const timeString = date 
          ? date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
          : "";

        let imageHtml = "";
        if (msg.imageBase64) {
          imageHtml = `<img src="${msg.imageBase64}">`;
        }

        div.innerHTML = `
          <div>
            <span class="username">${msg.username}</span>
            <span class="time">${timeString}</span>
          </div>
          <div>${msg.text || ""}</div>
          ${imageHtml}
          <div class="reply-btn" onclick="setReply('${msgId}')">Reply</div>
        `;

        messagesDiv.appendChild(div);
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  window.setReply = (id) => {
    replyToMessage = id;
    const replyBox = document.getElementById("replyingTo");
    replyBox.style.display = "block";
    replyBox.innerText = "Replying to message...";
  };
</script>

</body>
</html>
