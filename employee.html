<!DOCTYPE html>
<html>
<head>
  <title>Iron Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{
      margin:0;
      font-family:Arial;
      display:flex;
      height:100vh;
      background:#0f2027;
      color:white;
    }
    .sidebar{
      width:30%;
      background:#1c1c1c;
      overflow-y:auto;
      padding:10px;
    }
    .user{
      padding:10px;
      background:#2c2c2c;
      margin:5px 0;
      border-radius:8px;
      cursor:pointer;
    }
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      background:#203a43;
    }
    .messages{
      flex:1;
      overflow-y:auto;
      padding:10px;
    }
    .msg{
      margin:5px 0;
      padding:8px;
      border-radius:8px;
      max-width:60%;
    }
    .me{background:#00c6ff; align-self:flex-end; color:black;}
    .other{background:#2c5364;}
    .input{
      display:flex;
      padding:10px;
      background:#1c1c1c;
    }
    .input input{
      flex:1;
      padding:8px;
      border:none;
      border-radius:8px;
    }
    .input button{
      margin-left:5px;
      padding:8px 15px;
      border:none;
      border-radius:8px;
      background:#00c6ff;
      font-weight:bold;
      cursor:pointer;
    }
  </style>
</head>
<body>

<div class="sidebar" id="userList"></div>

<div class="chat">
  <div class="messages" id="messages"></div>
  <div class="input">
    <input type="text" id="messageInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc,
  serverTimestamp, query, where, onSnapshot
}
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6c1k8BURliiSAwEOnT_HW1MaZjNhHJSM",
  authDomain: "iron-companies.firebaseapp.com",
  projectId: "iron-companies",
  storageBucket: "iron-companies.firebasestorage.app",
  messagingSenderId: "692492696732",
  appId: "1:692492696732:web:cd29fc124ddc0fa014c159"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let currentChatId;

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.href="index.html";
  }
  currentUser = user;
  loadUsers();
});

async function loadUsers(){
  const snapshot = await getDocs(collection(db,"users"));
  const list = document.getElementById("userList");
  list.innerHTML="";
  snapshot.forEach(docSnap=>{
    if(docSnap.id !== currentUser.uid){
      const div=document.createElement("div");
      div.className="user";
      div.innerText=docSnap.data().username;
      div.onclick=()=>openChat(docSnap.id);
      list.appendChild(div);
    }
  });
}

async function openChat(otherUid){
  const q=query(collection(db,"chats"),
    where("members","array-contains",currentUser.uid));
  const snapshot=await getDocs(q);

  let found=false;
  snapshot.forEach(docSnap=>{
    if(docSnap.data().members.includes(otherUid)){
      currentChatId=docSnap.id;
      found=true;
    }
  });

  if(!found){
    const newChat=await addDoc(collection(db,"chats"),{
      members:[currentUser.uid,otherUid],
      createdAt:serverTimestamp()
    });
    currentChatId=newChat.id;
  }

  listenMessages();
}

function listenMessages(){
  const messagesRef=collection(db,"chats",currentChatId,"messages");
  onSnapshot(messagesRef,(snapshot)=>{
    const container=document.getElementById("messages");
    container.innerHTML="";
    snapshot.forEach(docSnap=>{
      const msg=document.createElement("div");
      msg.classList.add("msg");
      msg.classList.add(
        docSnap.data().senderId===currentUser.uid ? "me":"other"
      );
      msg.innerText=docSnap.data().text;
      container.appendChild(msg);
    });
  });
}

window.sendMessage=async function(){
  const text=document.getElementById("messageInput").value;
  if(!text || !currentChatId) return;

  await addDoc(collection(db,"chats",currentChatId,"messages"),{
    text:text,
    senderId:currentUser.uid,
    createdAt:serverTimestamp()
  });

  document.getElementById("messageInput").value="";
}
</script>

</body>
</html>
